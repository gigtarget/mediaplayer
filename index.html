<!--
  iOS26 Glass Music Player – single-file HTML/CSS/JS (editable + export to video)
  • Edit fields: Title, Artist, Duration (mm:ss), Cover image upload
  • Aspect presets: 16:9, 9:16, 1:1 (top-left)
  • Light/Dark toggle + Accent swatches
  • Render button exports a clean video of the player “playing” for the full duration
    - WebM (fast, built-in) rendered via headless canvas (no screen recording prompts)
    - MP4 (beta, slower) via ffmpeg.wasm transcoding the recorded WebM
  • Toolbars/controls auto-hide during render. Only the player is captured.
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>iOS26 Glass Music Player – Editable + Export</title>
<style>
:root{
  --bg1:#0b0f1a; --bg2:#151a29; --glass:rgba(255,255,255,.08); --glass-strong:rgba(255,255,255,.14);
  --stroke:rgba(255,255,255,.22); --text:#edf2ff; --muted:#a6b0c2; --accent:#6aa8ff; --accent-2:#b387ff;
  --shadow:0 20px 50px rgba(0,0,0,.45); --radius-xl:28px; --radius-lg:20px; --radius-md:14px;
}
.light{ --bg1:#f0f4ff; --bg2:#e8ecfb; --glass:rgba(255,255,255,.6); --glass-strong:rgba(255,255,255,.85);
  --stroke:rgba(10,20,40,.12); --text:#0b1020; --muted:#46506a; --shadow:0 12px 40px rgba(30,40,80,.18);}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; font-family:ui-sans-serif,system-ui,"SF Pro Text","Inter",Segoe UI,Roboto,Helvetica,Arial;
  background: radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.08), transparent 60%),
              radial-gradient(900px 700px at 90% 80%, rgba(255,255,255,.06), transparent 60%),
              linear-gradient(135deg,var(--bg1),var(--bg2));
  color:var(--text);
  display:grid; grid-template-rows:auto 1fr; gap:14px; padding:16px;
}

/* CONTROL PANEL (not recorded) */
.panel{display:flex;flex-wrap:wrap;gap:10px;align-items:end;padding:10px 12px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(255,255,255,.08));border-radius:16px;}
.panel label{font-size:12px;display:flex;flex-direction:column;gap:6px;color:var(--muted)}
.panel input[type="text"],.panel input[type="file"]{padding:10px 12px;min-width:220px;border-radius:10px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.06);color:var(--text)}
.panel .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.1));color:var(--text);cursor:pointer}
.panel .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none}
.panel .info{font-size:12px;color:var(--muted);margin-left:auto}

/* STAGE */
#stage{position:relative;width:min(92vw,1280px);aspect-ratio:16/9;border-radius:34px;overflow:hidden;margin:0 auto;}
#stage.frame-916{aspect-ratio:9/16;width:min(52vw,720px);}
#stage.frame-11{aspect-ratio:1/1;width:min(60vw,900px);}
.bg-orbs{position:absolute;inset:0;pointer-events:none}
.bg-orbs:before,.bg-orbs:after{content:"";position:absolute;filter:blur(80px);opacity:.55;mix-blend:screen;border-radius:50%}
.bg-orbs:before{width:42%;height:42%;left:-8%;top:-10%;background:radial-gradient(circle at 30% 30%,#6aa8ff,transparent 60%)}
.bg-orbs:after{width:46%;height:46%;right:-6%;bottom:-12%;background:radial-gradient(circle at 70% 70%,#b387ff,transparent 60%)}

.glass-wrap{position:absolute;inset:0;padding:28px;display:grid}
.player{margin:auto;display:grid;grid-template-columns:340px 1fr;gap:28px;align-items:center;
  background:linear-gradient(180deg,var(--glass-strong),var(--glass));backdrop-filter:blur(22px)saturate(1.25);
  -webkit-backdrop-filter:blur(22px)saturate(1.25);border:1px solid var(--stroke);border-radius:var(--radius-xl);
  box-shadow:var(--shadow);padding:24px;width:min(100%,1100px);outline:1px solid rgba(255,255,255,.055);}
.portrait .player{grid-template-columns:1fr}

/* COVER / VINYL */
.cover{position:relative;aspect-ratio:1/1;border-radius:24px;overflow:hidden;background:linear-gradient(135deg,#0d121f,#141b2d);
  border:1px solid var(--stroke);display:grid;place-items:center}
.vinyl{width:85%;height:85%;border-radius:50%;background:
  radial-gradient(circle at 50% 50%, #222 0 38%, transparent 38.2%),
  radial-gradient(circle at 50% 50%, #111 0 40%, #0b0f18 41% 64%, #05070c 65% 100%),
  repeating-conic-gradient(from 0deg, rgba(255,255,255,.06) 0 2deg, transparent 2deg 4deg);
  box-shadow:inset 0 0 0 6px rgba(0,0,0,.4),inset 0 0 60px rgba(0,0,0,.55);
  display:grid;place-items:center;animation:spin 18s linear infinite;animation-play-state:paused}
.cover.has-image .vinyl{width:100%;height:100%;border-radius:0;background-size:cover;background-position:center;box-shadow:none;animation-play-state:paused}
.playing .vinyl{animation-play-state:running}
.label{width:32%;height:32%;border-radius:50%;background:radial-gradient(circle at 40% 30%,#fff 0,#ddd 40%,#bbb 62%,#888 100%);
  box-shadow:inset 0 0 12px rgba(0,0,0,.5);display:grid;place-items:center;font-weight:700;color:#111;font-size:12px;text-transform:uppercase}
@keyframes spin{to{transform:rotate(360deg)}}

/* META */
.meta h1{margin:0 0 6px;font-size:28px}
.meta h2{margin:0 0 18px;font-size:16px;font-weight:500;color:var(--muted)}
.badges{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}
.badge{font-size:11px;padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06));text-transform:uppercase}

/* WAVE + CONTROLS */
.wave{height:78px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06));
  border:1px solid var(--stroke);overflow:hidden;position:relative;margin-bottom:16px}
.wave-bars{position:absolute;inset:0;display:grid;grid-template-columns:repeat(120,1fr);gap:2px;align-items:end;padding:10px}
.wave-bars span{display:block;border-radius:6px 6px 0 0;background:linear-gradient(180deg,var(--accent),var(--accent-2));opacity:.85;height:40%}
.timeline{display:grid;grid-template-columns:60px 1fr 60px;align-items:center;gap:12px}
.progress{height:8px;border-radius:999px;background:rgba(255,255,255,.14);border:1px solid var(--stroke);position:relative;overflow:hidden}
.progress .fill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 0 24px rgba(100,150,255,.35) inset}
.time{font-size:12px;color:var(--muted);text-align:center}
.controls{display:flex;align-items:center;gap:12px;margin-top:18px}
.btn{display:grid;place-items:center;width:44px;height:44px;border-radius:12px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.08));cursor:pointer;transition:.25s transform}
.btn:active{transform:translateY(1px)scale(.98)}
.btn.primary{width:56px;height:56px;background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;box-shadow:0 8px 28px rgba(106,168,255,.35)}

/* Toolbars */
.toolbar{position:absolute;top:18px;left:18px;display:flex;gap:10px;z-index:5}
.toolbar .chip{font-size:12px;padding:10px 12px;border-radius:999px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.1));cursor:pointer}
.toolbar .swatch{width:26px;height:26px;border-radius:999px;border:1px solid var(--stroke);cursor:pointer;box-shadow:inset 0 0 0 2px rgba(255,255,255,.25)}
body.exporting .panel,body.exporting .toolbar{display:none!important}
.credits{position:absolute;bottom:18px;left:18px;font-size:11px;color:var(--muted);opacity:.85}
</style>
</head>

<body>
<div class="panel" id="panel">
  <label>Song Title <input id="inTitle" type="text" value="Song Title – Lounge Edit"/></label>
  <label>Artist Name <input id="inArtist" type="text" value="Artist Name • House of Tyche"/></label>
  <label>Total Duration (mm:ss) <input id="inDur" type="text" value="03:28"/></label>
  <label>Cover Image <input id="inCover" type="file" accept="image/*"/></label>
  <button class="btn" onclick="setAspect('frame-169')">16:9</button>
  <button class="btn" onclick="setAspect('frame-916')">9:16</button>
  <button class="btn" onclick="setAspect('frame-11')">1:1</button>
  <button class="btn" onclick="toggleTheme()">Light/Dark</button>
  <div class="info">Render →
    <button class="btn primary" onclick="renderVideo('webm')">Video (WebM)</button>
    <button class="btn" onclick="renderVideo('mp4')">Video (MP4 β)</button>
  </div>
</div>

<div id="stage" class="frame frame-169">
  <div class="bg-orbs"></div>
  <div class="glass-wrap">
    <div class="player" id="player">
      <div class="cover" id="cover">
        <div class="vinyl" id="vinyl"><div class="label">SIDE • A</div></div>
      </div>
      <div class="right">
        <div class="meta">
          <h1 id="title" contenteditable>Song Title – Lounge Edit</h1>
          <h2 id="artist" contenteditable>Artist Name • House of Tyche</h2>
          <div class="badges"><div class="badge">Hi-Res</div><div class="badge">Stereo</div><div class="badge">24-bit</div></div>
        </div>
        <div class="wave"><div class="wave-bars" id="bars"></div></div>
        <div class="timeline">
          <div class="time" id="tcur">0:00</div>
          <div class="progress"><div class="fill" id="pfill"></div></div>
          <div class="time" id="tend">3:28</div>
        </div>
        <div class="controls">
          <button class="btn primary" title="Pause" onclick="togglePlay()">
            <svg width="22" height="22" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14" rx="1" fill="#fff"/><rect x="14" y="5" width="4" height="14" rx="1" fill="#fff"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="toolbar">
    <div class="chip" onclick="setAspect('frame-169')">16:9</div>
    <div class="chip" onclick="setAspect('frame-916')">9:16</div>
    <div class="chip" onclick="setAspect('frame-11')">1:1</div>
    <div class="chip" onclick="toggleTheme()">Light/Dark</div>
    <div class="swatch" style="background:linear-gradient(135deg,#6aa8ff,#b387ff)" onclick="setAccent('#6aa8ff','#b387ff')"></div>
    <div class="swatch" style="background:linear-gradient(135deg,#ff9d6c,#ffd66c)" onclick="setAccent('#ff9d6c','#ffd66c')"></div>
    <div class="swatch" style="background:linear-gradient(135deg,#7bd389,#2bd2ff)" onclick="setAccent('#7bd389','#2bd2ff')"></div>
  </div>
  <div class="credits">iOS26 Glass Music Player – visuals for video editors</div>
</div>

<script>
const qs=s=>document.querySelector(s),qsa=s=>[...document.querySelectorAll(s)];
const stage=qs('#stage'),player=qs('#player'),body=document.body;
function setAspect(c){stage.className='frame '+c;if(c==='frame-916')stage.classList.add('portrait');else stage.classList.remove('portrait');}
function toggleTheme(){body.classList.toggle('light');}
function setAccent(a,b){document.documentElement.style.setProperty('--accent',a);document.documentElement.style.setProperty('--accent-2',b);}

const inTitle=qs('#inTitle'),inArtist=qs('#inArtist'),inDur=qs('#inDur'),inCover=qs('#inCover');
const elTitle=qs('#title'),elArtist=qs('#artist'),elTcur=qs('#tcur'),elTend=qs('#tend'),elFill=qs('#pfill');
const cover=qs('#cover'),vinyl=qs('#vinyl');

inTitle.oninput=()=>elTitle.textContent=inTitle.value;
inArtist.oninput=()=>elArtist.textContent=inArtist.value;
inDur.oninput=()=>elTend.textContent=normTime(inDur.value);

// ✅ FIXED: Convert uploaded cover to Base64 data URL
inCover.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const dataUrl=ev.target.result;
    cover.classList.add('has-image');
    vinyl.style.backgroundImage=`url('${dataUrl}')`;
    vinyl.animate([{transform:'scale(1)'},{transform:'scale(1.02)'}],
      {duration:4000,direction:'alternate',iterations:Infinity});
  };
  reader.readAsDataURL(f);
});

function normTime(s){
  const m=/^\s*(\d{1,2})[:._-]?(\d{0,2})\s*$/.exec(s||'');if(!m)return'03:28';
  const mm=parseInt(m[1]||'0',10),ss=parseInt(m[2]||'0',10);
  return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}

// Playback simulation
let playing=false,startTs=0,rafId=null;
function durationMs(){const [m,s]=(elTend.textContent||'00:00').split(':').map(x=>parseInt(x,10)||0);return (m*60+s)*1000;}
function togglePlay(force){playing=force??!playing;player.classList.toggle('playing',playing);
  if(playing){startTs=performance.now();tick();}else cancelAnimationFrame(rafId);}
function progress(){return Math.min(1,(performance.now()-startTs)/durationMs());}
function fmt(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60),r=s%60;return`${m}:${String(r).padStart(2,'0')}`;}
function tick(){const pr=progress();elFill.style.width=(pr*100)+'%';elTcur.textContent=fmt(pr*durationMs());
  rafId=requestAnimationFrame(()=>{if(pr>=1)return togglePlay(false);tick();});}

// Wave
(function(){const bars=qs('#bars');for(let i=0;i<120;i++){const s=document.createElement('span');s.style.height=(20+Math.random()*58)+'%';bars.appendChild(s);}setInterval(()=>{
  qsa('#bars span').forEach(el=>{let h=parseFloat(el.style.height);el.style.height=Math.max(12,Math.min(90,h+(Math.random()*8-4)))+'%';});},500);})();

elTend.textContent=inDur.value;togglePlay(true);

// Rendering
async function renderVideo(fmt){
  try{
    body.classList.add('exporting');
    await new Promise(r=>setTimeout(r,150));
    elTcur.textContent='0:00';elFill.style.width='0%';startTs=performance.now();togglePlay(true);
    const fps=60;
    const mimeWebm=MediaRecorder.isTypeSupported('video/webm;codecs=vp9')?'video/webm;codecs=vp9':'video/webm';
    const webmBlob=await renderViaCanvasCapture(fps,mimeWebm,durationMs());
    if(fmt==='webm')saveBlob(webmBlob,safeFileName(inTitle.value)+'.webm');
    else{
      const mp4Blob=await transcodeWebMtoMP4(webmBlob);
      saveBlob(mp4Blob,safeFileName(inTitle.value)+'.mp4');
    }
  }catch(err){console.error(err);alert('Render failed: '+err.message);}
  finally{togglePlay(false);body.classList.remove('exporting');}
}

async function recordStreamToBlob(stream,mime,runForMs){
  const chunks=[],rec=new MediaRecorder(stream,{mimeType:mime,videoBitsPerSecond:8_000_000});
  rec.ondataavailable=e=>e.data&&chunks.push(e.data);const done=new Promise(res=>rec.onstop=res);
  rec.start(100);await new Promise(r=>setTimeout(r,runForMs));rec.stop();await done;
  return new Blob(chunks,{type:mime});
}

async function renderViaCanvasCapture(fps,mimeType,runForMs){
  const rect=stage.getBoundingClientRect();const scale=window.devicePixelRatio||1;
  const canvas=document.createElement('canvas');canvas.width=rect.width*scale;canvas.height=rect.height*scale;
  const ctx=canvas.getContext('2d');ctx.scale(scale,scale);
  const stream=canvas.captureStream(fps);
  const recordingPromise=recordStreamToBlob(stream,mimeType,runForMs+1000/fps);
  const cache=buildStyleCache(stage);const delay=1000/fps;const start=performance.now();
  while(performance.now()-start<runForMs){await paintStageFrame(ctx,rect.width,rect.height,cache);await new Promise(r=>setTimeout(r,delay));}
  await paintStageFrame(ctx,rect.width,rect.height,cache);
  const blob=await recordingPromise;stream.getTracks().forEach(t=>t.stop());canvas.remove();return blob;
}

function buildStyleCache(root){const c=new Map();(function walk(n){if(n.nodeType===1){const comp=getComputedStyle(n);let css='';for(const p of comp){if(p.startsWith('animation')||p.startsWith('transition')||p==='transform')continue;css+=`${p}:${comp.getPropertyValue(p)};`; }css+='animation:none!important;transition:none!important;';c.set(n,css);}n.childNodes.forEach(walk);})(root);return c;}

async function paintStageFrame(ctx,w,h,cache){
  const clone=stage.cloneNode(true);clone.setAttribute('xmlns','http://www.w3.org/1999/xhtml');
  syncComputedStyles(stage,clone,cache);
  const serialized=new XMLSerializer().serializeToString(clone);
  const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><foreignObject width="100%" height="100%">${serialized}</foreignObject></svg>`;
  const blob=new Blob([svg],{type:'image/svg+xml'});
  ctx.clearRect(0,0,w,h);
  const bmp=await createImageBitmap(blob);ctx.drawImage(bmp,0,0,w,h);bmp.close();
}

function syncComputedStyles(src,dest,cache){
  if(src.nodeType===1&&dest.nodeType===1){
    const base=cache.get(src)||'';const comp=getComputedStyle(src);
    const transform=comp.transform&&comp.transform!=='none'?`transform:${comp.transform};`:'';dest.setAttribute('style',base+transform);
  }
  const sC=[...src.childNodes],dC=[...dest.childNodes];
  for(let i=0;i<sC.length;i++)syncComputedStyles(sC[i],dC[i],cache);
}

function saveBlob(b,n){const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),2e3);}
function safeFileName(s){return(s||'output').replace(/[^\w\-\s\u00A0-\uFFFF]/g,'').trim().replace(/\s+/g,'_');}

// ffmpeg.wasm
let ffmpegReady=false,ffmpegRef=null;
async function ensureFFmpeg(){
  if(ffmpegReady)return ffmpegRef;
  await import('https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js');
  const{createFFmpeg,fetchFile}=FFmpeg;
  const ffmpeg=createFFmpeg({log:true,corePath:'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js'});
  await ffmpeg.load();ffmpeg.fetchFile=fetchFile;ffmpegReady=true;ffmpegRef=ffmpeg;return ffmpeg;
}
async function transcodeWebMtoMP4(webmBlob){
  const ffmpeg=await ensureFFmpeg();const webmData=await ffmpeg.fetchFile(webmBlob);
  ffmpeg.FS('writeFile','input.webm',webmData);
  await ffmpeg.run('-i','input.webm','-c:v','libx264','-pix_fmt','yuv420p','-preset','veryfast','-crf','20','-c:a','aac','-b:a','192k','-movflags','+faststart','output.mp4');
  const data=ffmpeg.FS('readFile','output.mp4');
  return new Blob([data.buffer],{type:'video/mp4'});
}
</script>
</body>
</html>
